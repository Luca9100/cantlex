<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>grr.li</title>
  <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
  <link rel="manifest" href="favicon/site.webmanifest">
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 50px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 90vh;
      background-color: white;
      color: black;
      transition: background-color 0.3s, color 0.3s;
    }
    h1 { font-size: 64px; }
    input {
      padding: 20px;
      width: 300px;
      margin: 10px 0;
      font-size: 18px;
      background-color: #fff;
      color: #000;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .autocomplete-list {
      position: absolute;
      top: calc(100% + 5px);
      width: 300px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 5px;
      max-height: 180px;
      overflow-y: auto;
      z-index: 10;
    }
    .autocomplete-item {
      padding: 10px;
      cursor: pointer;
    }
    .autocomplete-item:hover,
    .autocomplete-item.active {
      background-color: #efefef;
    }
    .footer {
      font-size: 16px;
      color: lightgrey;
      margin-top: auto;
      padding: 20px 0;
    }
    .footer a {
      text-decoration: none;
      color: lightgrey;
    }
    body.dark-mode {
      background-color: #121212;
      color: #eee;
    }
    body.dark-mode input {
      background-color: #1e1e1e;
      color: #eee;
      border: 1px solid #555;
    }
    body.dark-mode .autocomplete-list {
      background-color: #1e1e1e;
      border-color: #555;
    }
    body.dark-mode .autocomplete-item {
      color: #eee;
    }
    body.dark-mode .autocomplete-item.active,
    body.dark-mode .autocomplete-item:hover {
      background-color: #333;
    }
    body.dark-mode .footer,
    body.dark-mode .footer a {
      color: #aaa;
    }
    #themeToggle {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 24px;
      background: none;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <button id="themeToggle" onclick="toggleTheme()">üåô</button>
  <h1>grr.li</h1>

  <div style="position: relative;">
    <input
      type="text"
      id="abbreviation"
      placeholder="Abk√ºrzung oder Kurztitel eingeben"
      onkeydown="handleKey(event)"
      oninput="showSuggestions()"
      autocomplete="off"
      autofocus
    />
    <div id="autocomplete-list" class="autocomplete-list" style="display: none;"></div>
  </div>

  <div class="footer">
    <a href="https://www.grr.li/about">√úber grr.li</a>
  </div>

  <script>
    let allEntries = [];
    let filteredList = [];
    let selectedIndex = -1;

    function loadAbbreviationMap() {
      console.log("üîÑ Loading abbreviation map...");
      fetch("abbreviations.json")
        .then((response) => response.json())
        .then((data) => {
          allEntries = data;
          console.log(`‚úÖ Loaded ${data.length} entries.`);
          handleDirectResolution();
        })
        .catch(err => {
          console.error("‚ùå Failed to load abbreviations.json:", err);
        });
    }

    function extractArticles(input) {
      const regex = /\b\d+[a-z]?\b/gi;
      return input.match(regex) || [];
    }

    function resolveAbbreviation() {
      const rawInput = document.getElementById("abbreviation").value.trim();
      const inputLower = rawInput.toLowerCase();
      const articles = extractArticles(inputLower);
      const article = articles.length > 0 ? articles[0] : null;
      if (article) console.log("üîé Article detected:", article);

      const cleanedInput = inputLower.replace(/\b\d+[a-z]?\b/gi, "").replace(/\s+/g, " ").trim();

      const normalize = str => (str || "").toLowerCase().trim();

      const match = allEntries.find((entry) => {
        const abbr = normalize(entry.abbreviation);
        const title = normalize(entry.title);
        const input = normalize(cleanedInput);

        const exactMatch = abbr === input || title === input;
        const partialMatch = abbr.includes(input) || title.includes(input);

        return exactMatch || partialMatch;
      });

      if (match) {
        console.log("‚úÖ Match found:", match.abbreviation || match.title);
        let baseUrl = match.url;
        if (article) {
          if (baseUrl.startsWith("https://www.zhlaw.ch") && match.canton === "ZH") {
            baseUrl += `#seq-0-prov-${article.toLowerCase()}`;
          } else {
            baseUrl += `/art/${article.toLowerCase()}`;
          }
        }
        console.log("‚û°Ô∏è Redirecting to:", baseUrl);
        window.location.href = baseUrl;
      } else {
        console.warn("‚ùå Kein passender Erlass gefunden");
        alert("Kein passender Erlass mit dieser Referenz gefunden");
      }
    }

    function showSuggestions() {
      const input = document.getElementById("abbreviation");
      const value = input.value.toLowerCase().replace(/\b\d+[a-z]?\b/gi, "").trim();
      const list = document.getElementById("autocomplete-list");
      list.innerHTML = "";
      selectedIndex = -1;

      if (!value) {
        list.style.display = "none";
        return;
      }

      filteredList = allEntries.filter((entry) => {
        const abbr = (entry.abbreviation || "").toLowerCase();
        const titl = entry.title.toLowerCase();
        return abbr.includes(value) || titl.includes(value);
      }).slice(0, 10);

      if (filteredList.length === 0) {
        list.style.display = "none";
        return;
      }

      filteredList.forEach((entry) => {
        const div = document.createElement("div");
        div.classList.add("autocomplete-item");
        div.textContent = `${entry.abbreviation ? entry.abbreviation + " ‚Äì " : ""}${entry.title} (${entry.canton})`;
        div.onclick = () => {
          document.getElementById("abbreviation").value = (entry.abbreviation || entry.title) + " ";
          document.getElementById("abbreviation").focus();
          closeSuggestions();
        };
        list.appendChild(div);
      });

      list.style.display = "block";
    }

    function handleKey(event) {
      const list = document.getElementById("autocomplete-list");
      const input = document.getElementById("abbreviation");

      if (event.key === "ArrowDown") {
        event.preventDefault();
        if (selectedIndex < filteredList.length - 1) selectedIndex++;
        updateActiveItem();
      } else if (event.key === "ArrowUp") {
        event.preventDefault();
        if (selectedIndex > 0) selectedIndex--;
        updateActiveItem();
      } else if (event.key === "Enter" || event.key === "Tab") {
        if (list.style.display === "block" && selectedIndex > -1) {
          event.preventDefault();
          input.value = (filteredList[selectedIndex].abbreviation || filteredList[selectedIndex].title) + " ";
          closeSuggestions();
        } else if (event.key === "Enter") {
          resolveAbbreviation();
        }
      }
    }

    function updateActiveItem() {
      const items = document.querySelectorAll(".autocomplete-item");
      items.forEach((item, index) => {
        item.classList.toggle("active", index === selectedIndex);
      });
    }

    function closeSuggestions() {
      const list = document.getElementById("autocomplete-list");
      list.innerHTML = "";
      list.style.display = "none";
      selectedIndex = -1;
    }

    document.addEventListener("click", (e) => {
      if (!document.getElementById("abbreviation").contains(e.target)) {
        closeSuggestions();
      }
    });

    function handleDirectResolution() {
      const path = window.location.pathname.slice(1).toLowerCase().trim();
      if (!path) return;

      const entry = allEntries.find(e =>
        e.abbreviation.toLowerCase() === path || e.title.toLowerCase() === path
      );

      if (entry) {
        window.location.href = entry.url;
      }
    }

    function toggleTheme() {
      const body = document.body;
      const button = document.getElementById("themeToggle");
      const isDark = body.classList.toggle("dark-mode");
      button.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
      localStorage.setItem("theme", isDark ? "dark" : "light");
    }

    function setPlaceholder() {
      const examples = [
        "Abk√ºrzung oder Kurztitel eingeben", "StipVO", "GesG", "VV KKG", "ZH 5a", "fr loi", "it legge"
      ];
      const input = document.getElementById("abbreviation");
      input.placeholder = examples[Math.floor(Math.random() * examples.length)];
    }

    window.onload = function () {
      loadAbbreviationMap();
      setPlaceholder();
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "dark") {
        document.body.classList.add("dark-mode");
        document.getElementById("themeToggle").textContent = "‚òÄÔ∏è";
      }
    };
  </script>
</body>
</html>
